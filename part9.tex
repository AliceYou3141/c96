\chapter{メールサーバとオンプレミス}

メールのシステムは、オンプレミスと仮想環境、どちらで構築するのがベターでしょうか。これまでは、単純にメールサーバはオンプレミスと言えば済んでいました。

ですが、現在はコンテナやVMを実用的に使う技術が普及しています。メールサービスに置いてはこれらをどのように考えれば良いか、本章では、そのことについて考えます。

\section{オンプレミスとメールサーバ}

減在でも、メールサーバはオンプレミスで構築されることが多いです。特に、ユーザにメールサービスを提供するためのメールシステムは、オンプレミスで構築されます。
なぜ、現在でもメールサーバだけはオンプレミスで構築されることが多いのでしょうか。

\subsection{リソースの専有}

メールサーバをオンプレミスで実装するときの必然性は、物理ホストのリソースの専有です。
特に、ユーザに対してメールの送受信をサービスするサーバは、常時繰り返されるネットワーク接続とディスクI/Oが生じる、とういう傾向があります。

そのため、ハードウェアリソースの配分が隠蔽されない環境、制御可能な環境である子とが望ましい、ということになります。
また、ＮＩＣをとランキングする、ディスクアレイをRAID化してパフォーマンスと冗長化を両立する、というような、メールサーバに必要となる要求を満たすためにも、オンプレミス構築は必然性を持ちます。

\subsection{メールデータの保存ホスト}

ユーザにメールアドレスを提供するサービスの場合、メールの保存のために、大容量のファイルシステムが必要になります。また、そのファイルシステムは、物理レベルで他のユーザとの共有がないことが望ましいという傾向があります。

そのため、メールデータの書き込み、ユーザからのアクセスへの対応、更に、データのバックアップの行いやすさまで考えると、オンプレミスで実装するのはそれほど荒唐無稽なことではありません。

\subsection{バックアップの長期保存}

現在、ISOなどの運用規格や、輸出入の関連法規で、メールデータの長期保存が必要とされています。10年単位の長期保存には、テープに書き出すなどの方法が採られます。
また、メールを長期保存するための、専用のアーカイバ製品も、企業向けに販売されています。これらの手段でバックアップを行う必票があるのであれば、メールサーバをオンプレミスで構築し、同じサーバフファームにアーカイブ用のサーバを設置する、という構成が有利です。

こういう製品は、クラウドベースのメールサービスからのバックアップも可能ですが、メールデータが隊リュになる場合は、全データのネットワーク経由コピーの時間を考えなければなりません。その意味でも、メールサービスに歓喜っては、オンプレでデータを保存するのが有利、という考えになります。

\section{VMとメールサーバ}

仮想化環境としてコンテナが一般化した現在、ハイパーバイザーによる仮想マシン(VM)でメールサーバを動作させることに対しての疑問が生じるかもしれません。

ですが、メールサーバは構造的に、オンプレミスでの実装が難しい場合は、VMの上に実装するのが、まだ現実的な面があります。ここでは、ＶＭ上でのメールサーバ構築について考えてみましょう。

\subsection{OSのサービスの利用}

メールサーバを収容するのに、コンテナよりもVMがまだ現実的である理由のひとつが、VMのほうがOSのサービスを利用しやすい、という点にあります。

Postfixをはじめとするメールサーバは、ほとんどがログの出力。保存について、syslogd(8)もしくは互換アプリケーションに依存しています。また、メールサーバとsyslogd（8）お間の通信は、UNIXドメインソケットを使用します。そのため、Dockerでは、/sbin/initを起動プロセスとしたコンテナにPostfixを収容し、syslogd(8)を起動しておくこととなります。

このような運用を考えると、ハードウェアのリソース配分が可能なVMにメールサーバを収容するほうがよい、そうかんがえることができます

\subsection{ハードウェアのリソース分配}

コンテナとVMを比較したときの特徴として、ハイパーバイザーによって、ハードウェアのリソース分割が厳密に行われる、という点があります。これは、CPU,ストレージ、SR-IOV機能を利用したネットワークインタフェイスの倫理分割などに及びます。

メールサーバとして仮想環境を利揺することを考えたとき、一定量のリソースが確実に確保できるというのが利点です。また、オンプレミスにない利点として、ストレージ容量を追加しやすい、というメリットもあります。

その一方で、VMは、ディスクアクセスとネットワークの性能はオンプレミスに及ばないという欠点があります。そのため、大量のユーザを収容するメールサーバビスに適用するには、十分な性能の検討が必要です。

\section{コンテナとメールサーバ}

仮想化の手段のグループのひとつである、コンテナでメールサーバを稼働させる、というのはどういうものでしょうか。
ここでは、Linuxで多用されているDockerとメールサーバの関係を考えてみます

\subsection{コンテナにメールサーバを収容する}

コンテナにPostfixなどのメールサーバを収容するとき、ひとつ問題があります。それは、メールサーバのプロセスと、syslogd(8)の両方が必要になる、ということです。

メールログが不要であれば、Postfixの場合、master(8)を起動プロセスとすることで、Postfixのコンテナを動かすことが可能です。とはいえ、メールのろぐが取れないため、実用性という意味では疑問が残ります。

また、incoming queueのアクセスが多くくなりがちなので、その点でも、無理にコンテナに収容する設計にする必然性は薄いということができるでしょう。

\subsection{コンテナに向くサービス}

Postfixそのものはコンテナに向くとは言いづらいところがあります。ですが、Postfixテーブルの外部データベース、milterなど、単一プロセスにのコンテナで動かしやすいものがあります。

同様に、単体のWebサービスとして稼動する、Webメールインタフェイスのサーバも、コンテナ向きであるといえます。Webメールサーバは、実体は、IMAPプロtコルでメールサーバと通信をするサービスです。

また、Postfixテーブルで外部データベースとして、RDEBMSやLDAPを使用するときは、そのプロセスをコンテナとして動かすことは有効です。
また、milterはモノリシックなプロセスで動作すること、ネットワーク等価であることから、コンテナで稼動させるのに向いています。、

RDBMSもLDAPも、ディスクのリードが多くなる傾向があります。また、milterでウィルスチェックを行う場合は、添付ファイルを展開して検査します。そのため、コンテナがどの物理インスタンス上で動作しているかを把握し、コンテナホスト側から見たときの、ディスクI/Oの排他制御の発生を減らすように考える必要があります。

それでも、レイテンシが現実的な範囲であれば、オンプレミスのメールサーバへのサービスとして、コンテナを利用する設計も、有用であると考えられます。それは、オンプレミスとコンテナのいいとこ取りで、システム全体を構築するという考え方です。