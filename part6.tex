\chapter{メールのリレーとルーティング}

SMTPでメールを扱うには、メールを転送するという概念を理解する必要があります。
メールの転送を、メールリレーと言います。また、メールの経路を決定するという意味で、メールルーティングとよんでいます。
ここでは、そのメールのリレーとルーティングについて見直していきましょう。


\section{メールの転送}

メールを転送するというのはどういうことなのでしょうか。まずは、その疑問について考えてみましょう。
メールの転送というのは、メールというデータを、あるSMTPクライアントから、SMTPサーバに転送することです。

また、別のプロセスに転送する場合、その転送先プロセスをネクストホップと呼ぶことがあります。

まずは、そのメールの転送について考えます。


\subsection{メールデータの転送}

メールホストの間で、メールを転送するというのはどのようなことなのでしょうか。あるホストから別のホストに、メールを転送するということを考えます。

メールを転送する元のホストでは、キューに入れられたメールを読み出します。キューから読み出したメールで、宛先がこのホストであれば、ローカルストレージに保存します。
また、宛歴が別のメールホストであれば、SMTPで宛先のホスト転送します。

そのいずれかが行われた場合、キューにあるメールのデータは削除されます。つまり、ネクストホップへの転送、もしくは、ローカルファイルシステムへの保存というイベントによって、キューのデータは削除されます。

そうすることによって、メールが宛先に向かって移動する、という、郵送メールのような概念が実現されています。

\subsection{メールリレー}

SMTPというプロトコルは、サーバ艦転送で、宛先にかかわらず、他のメールサーバにメールを転送することを許容しています。
たとえば、uranohoshi.exampleのメールサーバに、otonokizaka.example宛のメールを転送してもかまいません。このとき、uranohosi.exampleは、otonokizaka.exampleのメールサーバに到達可能なメールサーバに、メールを転送します。

このように、あるメールサーバが、自分以外を宛先とするメールを受け取ったとき、そのメールを宛先、もしくは宛先に到達可能なメールサーバに転送することを、メールリレーと呼びます。

\subsection{サードパーティーリレー}

メールリレーはSMTPによるｍメール転送の基本ですが、現在では、ほとんどのメールサーバは、自分を宛先とするメール以外は受け取らない設定となっています。
これは、メールリレーの機能がspamなど、問題あるメールの転送に使われ留ことが多かったためです。こうすることで、直接自分からメールを出すのではなく、設定の緩いメールサーバにリレーさせることができます。

このような転送を、サードパーティーリレー(第三者転送)と呼びます。そして、セキュリティの問題から、インターネットに公開するメールサーバは、第三者転送を許可しない設定とする、暗黙の了解がされています。

サードパーティーリレーという概念そのものは、単にメールの扱いの本質を著わしているだけなのですが、その用いられ方から、今日では、セキュリティ上の問題として扱われています。

\subsection{例外的に行われるサードパーティーリレー}

セキュリティ上問題のあるサードパーティーリレーですが、現在でも例外的に行われているものがあります。それは、認証を行ったクライアントからノメールのみ、サードパーティーリレーをする、というものです。

現在の、多くのユーザのメールの利用方法は、メールサーバにSMTPでメールを送り、そのメールをサードパーティーリレーしてもらうというものです。このとき、誰でもそのサーバを利用できるとセキュリティの問題となるため、SMTP認証やPbS\footnote{POP before SMTP SMTP-AUTH普及前は、クライアントにメール送信直前にPOPによるアクセスを課し、そのアクセスを行ったクライアントから一定時間のメール送信を許可していました}など、なんらかの認証を行い、正当なそのサーバのユーザと破堤された場合のみメールを転送しています。

あまり意識されていませんが、この部分は広義のサードパーティーリレーとなります。

\subsection{なぜメールはリレーできるのか}



\subsection{ルーティング}

メールは、ただ一度のメールリレーで、必ずしもメールが目的地に着いた、ということにはなりません。
多くの場合、メールの転送先は、そのドメインに対してMX検索を行い、得られたメールサーバ情報に従って、メールを転送します。ですが、必ずしもそのメールサーバがメールの終点というわけではありません。

メールを転送したサーバから、更に別のメールサーバにメールが転送されることもあります。その転送先は、そのメール転送を実行するメールサーバによって決定されます。

このように、目的地に到達するまで、メールを他のサーバに転送する、経路設定をメールルーティングと言います。

メールルーティングは、一定の規則に基づいて行われるときに、ルーティングをしているといいます。たとえば、全てのメールをセキュリティチェック用のメールサーバで受け、その検査で問題が無かったメールを、最終目的地のサーバに送る、という場合を考えます\footnote{商用サービスで、実際に、ドメインのMXとして振る舞い、メールをフィルタリングして宛先のメールサーバにに転送するフィルタリングサービスがあります}。

フィルタのホスト名を、mail.filter.exampleとします。このフィルタを、uranohoshi.exampleドメインのメールサーバのフィルタリングに使用するとき、MXレコードにmail.filter.exampleを書きます。

\begin{verbatim}
@ IN SOA ns.uranohoshi.example {...}
...
    IN MX 10 mail.filter.example
\end{verbatim}

こうすると、ドメインuranohoshi.example宛のメールは、ホストmail.filter.exampleに送られます。次に、mail.filter.exampleは、何らかの検査を行ない、問題がなかったメールを、本来のuranohosi.exampleドメインのメールサーバに転送します。

ｊこのとき、外部からは、uranohosi,exampleドメイン宛のメールは、すべてmail.filter.exampleを経由して、uranohoshi.exampleドメインのメールサーバに転送されるように見えます。これが、uranohoshi.exampleドメイン宛メールの受信におけるメールルーティングとなります。


\subsection{メール転送におけるプロセス間通信}

インターネットプロトコルスイートにおけるアプリケーションとは、トランスポート層のサービスを利用して、他のプロセスと通信するプロセスです。

つまり、メールの転送とはアプリケーション層における通信です。トランスポート層以下のサービスはあくまでもデータを転送する手段であり、メールを転送する経路の決定には関わりません。

メール転送をプロセス間通信という観点で見ると、それは送信元のプロセスから、送信先のサーバというプロセスへのプロセス間通信となります。

ただし、Postfixは、複数のプロセスが協調して動作するメールシステムです。Postfixでは、smtpd(8)がメールを受け取るプロセス、smtp(8)がメールを他のプロセスに転送するプロセスとなります。つまり、smtpd(8)がPostfixというメールサーバのデータの入り口であり、smtp(8)が、Postfixから他のメールサーバにメールが出ていく出口となります。

\subsection{メールのクライアントとサーバ}

SMTPのプロトコルでは、クライアントがイニシエイターとなって、サーバプロセスと通信を行います。このとき、トランスポート層として、TCPを使用します。

つまり、メール転送はクライアント・サーバ型のサービスです。ですが、一般にメールの転送は、サーバとサーバの間の転送のように見えます。
これを理解するためには、メールサービスとを提供するもの、という意味のサーバと、サーバ・クライアント型のサービスにおける、サーバ役のプロセスとしてのサーバを区別する必要があります。
ここでは、後者をサーバ側プロセスと呼ぶことにしましょう。

メール転送では、メー0ルを送信する側は、必ずクライアントとなります。これは、メールサーバ同士の転送としても、送信元となるメールサーバは、クライアントとして振る舞います。そしてそのクライアントから、TCPによる接続を受けたプロセスが、サーバ側プロセスとなります。


\subsection{転送によるメールの変化}

メールリレーによって、メールは必ず変化します。少なくとも、エンベローブ部分に、到達したサーバの情報が付加されます。それによって、そのメールが通過したサーバを全て知ることができます。

また、リレーされたメールサーバが、メールを加工することを役割としてた場合、当然ながら本文や添付ファイルなどが変化します。

\subsection{転送しないメール}

メールは、他のサーバに転送しない、というメールもあります。それはどのようなメールかというと、宛先が、自分であった場合、そのメールは他のメールサーバには転送しません。つまり、最終宛先におけるメール保存が行われます。

もし、メールの宛先のドメインやホスト名が、main.cf(5)のmydestinationディレクティブに指定されていたものと一致したら、Postfixは、そのメールの宛先サーバが自分であると判断します。

このときは、メールをローカルのストレージに保存します。内部的には、locak(8)もしくはvirtual(8）によって、ローカルストレージに保存されます。

この時の保存先は、必ず、Postfixが稼動するホストでの、ローカルのファイルシステムになります。逆に言えば、最終的なメールデータの保存先として、ローカルのファイルシステムを用意する必要があります。

\subsection{転送できないメール}

宛先のメールサーバが応答しない場合など、転送できない状態にあるメールはどのような扱いになるのでしょうか。

SMTPでは、メールの転送は一定期間リトライが行われます。それまでは、キューにメールが置かれたままです。一定期間野間だに転送ができなかったメールは、キューから破棄され、送信元は、メールによってエラーが返されます。


\subsection{戻ってきたメール}

メールは、通常はDNSのMXの情報によって、宛先のメールサーバに直接転送されます。また、本章で説明するメールルーティングによって、いくつかのメールサーバを経由して転送される場合もあります。

ですが、転送を繰り返した結果、あるメールサーバが贈りだしたメールが、別のメールサーバを経由して、転送先として転送されてくることがあります。
このように、メールが戻ってくることを、メールがループしている、メールループ、というようにいいます。

アルメールがループしているかは、そのメールのエンベローブを見ることで判断することができます。多くのメールサーバは、メールのループを検出し、そのようなメールは外に転送せずに破棄します。

あるサーバに届いたメールで、エンベローブ内に自分の名前があれば、そのメールはループするものと判断することができます。

\section{転送先の決定}

メールの転送先は、どのように決定をされるのでしょうか。Ｐｏｓｔｆｉｘでは、MXとAAAAやAを問い合わせるDNS参照、デフォルトの転送先設定、宛先毎の転送先テーブル、という、三種類の決定方法があります。

このときのメールの転送先は、必ずメールサーバ、つまり、SMTPを待ち受けるホストとなります。

また、転送先と決定とは厳密には異なるのであるが、エイリアスという概念もあります。

\subsection{MX参照}

宛先メールアドレスのアットマークから後ろを見て、それをDNSのMXフィールドのクエリとして問い合わせを出します。MXは、あるインターネットドメインのメールサーバの名前を表すためのフィールドです。

そのクエリに対して最終的にFQDNが回答として得られれば、転送先のメールサーバの名前として、その結果を利用します。ただし、MXへの回答を利用する場合、宛先ドメイン名と、そのメールサーバのインターネットドメイン名が一致しないことがあります。

たとえば、uranohoshi.exampleというドメイン宛のメールのMXを問い合わせた合、mail.lovelive.examplというFQDNが得られたとします。
このときは、mail.lovelive.exampleというホストが、ドメインuranohoshi.exampleのメールサーバであるとして、メールを転送する、ということです。

\subsection{AAAAとAの参照}

MX参照でメールサーバの名前が得られた場合は、DNSに対して、続いてAAAA\footnote{AAAAでAが4個あることから、クアッドAと読みます}もしくはAフィールドの取り合わせを行います。

あるホスト名に対して、AAAAﾊIPv6のアドレスを、Aは、IPｖ4のアドレスを記載したフィールドです。同じホストに対して両方のフィールドが存在し、PositfixがIpv6に対応する設定がされていれば、IPv6の結果が優先されます。そうでない場合は、IPv4の結果が使われます。

また、MXへの問い合わせで答えがえら得ない場合は、メールアドレスのアットマークから後をホスト名とみなして、問い合わせを行います。
DNSへの問い合わせで該当するホストのiPv6アドレスもしくはIPv4アドレスが得られれば、それを宛先として、メールの転送を行います。


\subsection{デフォルトの転送先}

Postfixでは、relay\_hostディレクティブで、全てのメールを転送する先を指定する小田できます。relay\_hostディレクティブに指定されたホストへは、mydestination宛以外全てのメールを転送する先となります。
この転送先としては、ドメインを指定してMX検索した結果のメールサーバに転送する指定と、MX検索無しで特定のホストを指定するものとで、指定が可能です。

後者の場合、転送先のポート番号を指定することも可能です。それを利用して、同一ホストで稼動し、SMTP以外のポートで待ち受けるポルセスにメールを転送することも可能です。

relay\_hostディレクティブには全てのメールを転送する先となります。逆にいえば、relay\_hostディレクティブで指定されたメールサーバは、複数のホストからのメールを、宛先にかかわらず集めることができます。
この考えを用いると、ユーザからのメール送信を老け付けるサーバを複数置き、そのサーバからメールを集めて外のメールサーバに転送する、という、運用をすることができます。





\subsection{宛先毎の転送テーブル}

Postfixでは、宛先毎の転送先の情報を、Postfix形式テーブルとして持つことができます。これは、transport(5)テーブルで記載されます。

transport(5)では、転送元は、メールアドレス、ドメインのいずれも書くことができます。また、転送先として、特定のメールアドレス、あるドメインのMXを参照して転送、ある特定のホストに転送、という使い分けが可能です。

転送テーブルを参照する場合も、特定のホストを宛先とする場合、ポート番号も併せて併記することができます。

\subsection{エイリアス}

エイリアスは、そのメールサーバが宛先となるのメールアドレスのうち、その宛先に届いたメールの転送先として、指定されるメールアドレスです。
Postfixのエイリアスは、sendmail互換機能として導入された経緯があります。そのため、sendmail形式でテーブルファイルを書き、互換の管理コマンドであるnewaliases(8)でハッシュ化すると有効になります。

また、エイリアスのテーブルとして、Postfixテーブル形式を用いることもできます。その場合は、main.cf(5)で、alias\_mapsディレクティブで、Postfixテーブルを指定します。

Postfix出のエイリアスの処理は、該当するメールの宛先をtrivial-rewrite(8)で書き換え、転送可能なメールとして受信し直すという流れになります。そのため、そのメールサーバが宛先でない、外部に転送する必要のあるメールアドレスを指定することも可能です。

\subsection{milterとネットワーク透過}

Postfixは、milterと連携して、メールの解析や書き換えを行うことができます。milterというのは、mail filterの略語として付けられた名称で、メールサーバとは独立して動作するプロセスです。
milterは、もともとはsendmailに機能を追加するためのプラグインの方式であり、Postfixなど、いくつかのメールサーバもそれを利用するための機能を実装しています。

つまり、milterというのは、メールサーバに機能を追加するために動作するプロセスの総称です。グレイリスティングなど単機能のフィルタリングを実現するためのmilter、amavisや各種アンチウィルスツールと連携するためのmilter、複数milterを同時に利用するためのmilterなどがあります。

milterは、SMTPでメールの情報を受け取り、milterプロトコルでそのメールの扱いを、メールサーバに指示します。SMTPを利用するので、これはメール転送と同様に、アプリケーション層のプロセス間通信となります。

ですが、milterの場合は、SMTPを、メールを転送するのではなく、メールのコピーを引き渡すのに使います。そのため、milterに渡されたメールはコピーであり、オリジナルはキューに残ったままです。

milterからの負うとも、アプリケーション層のプロセス間通信として返されます。これは、メールを受け取るか拒否するか、受け取る場合は何らかの加工をするか、というような指示です。SMTPでメールデータそのものが戻ってくるわけではないことに気をつけてください。

\section{メールハブ・メールゲートウェイ}

複数のメールサーバのデフォルト転送先となっているメールサーバを、メールハブやメールゲートウェイと呼びます。
メールハブを利用した構成都は、どのようなものでしょうか。

\subsection{メールのハブ}

メールハブという名称は、どのようなところから来ているのでしょうか。それは、ここまで説明したメールルーティングによって、メールを中継するためにメールが集められるメールサーバである、ということです。また、集められたメールを、次の行き先に分配する、という役割もあります。

このように、『一度集める』という意味でのHUBであり、ネットワーク機器のHUBや、ハブ空港のハブと同じ意味合いを持ちます。

また、メールハブとなるサーバのことを、メールゲートウェイという呼び方をすることもあります。これは、ネットワークのゲートウェイとなるルータに機能が似ているからです。

このようにメールルーティングはネットワークのルーティングのメタファーで説明されることが多いですが、メールルーティングはあくまでもアプリケーション層でのデータ転送です。トランスポート層以下の機能は関連しませんので、その点は注意をしてください。

\subsection{代表するメールサーバによる送信}

メールハブとなるメールサーバに、複数のメールサーバからのメールを集中して、そのメールを外部のメールサーバに転送する、という、メールサーバ群の構成があります。

この方法は、複数のメールサーバが必要なときに、外部と通信するメールサーバをメールは部に限定することで、セキュリティを向上させたり、ウィルスチェックなどの機能を担当するホストの台数を減らしたりする、というような構成が可能です。




\subsection{代表するメールサーバによる受信}

あるドメインについて、外からメールを受信するサーバは1台だけで、そこからサブドメイン毎のメールサーバへの転送を行う方法があります。Jこの場合も、外部と通信するサーバを限定することで、セキュリティを向上させるという効果があります。

Postfixでは、transport(5)で、ネクストホップを定義することで、メールハブからのメール振り分けを実現します。このｔき、canonicalやエイリアスを利用して、最終的な宛先を書き換える実装とすることがあります。